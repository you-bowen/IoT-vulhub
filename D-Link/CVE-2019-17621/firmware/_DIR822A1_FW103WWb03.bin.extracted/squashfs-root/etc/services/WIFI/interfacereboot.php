<?
include "/htdocs/phplib/xnode.php";
include "/htdocs/phplib/trace.php";

function isscheduled($uid)
{
	$p = XNODE_getpathbytarget("", "phyinf", "uid", $uid, 0);
	$sch = XNODE_getschedule($p);
	return $sch;
}
function schcmd($uid)
{
	/* Get schedule setting */
	$sch = isscheduled($uid);
	if ($sch=="") $cmd = "start";
	else
	{
		$days = XNODE_getscheduledays($sch);
		$start = query($sch."/start");
		$end = query($sch."/end");
		if (query($sch."/exclude")=="1") $cmd = 'schedule!';
		else $cmd = 'schedule';
		$cmd = $cmd.' "'.$days.'" "'.$start.'" "'.$end.'"';
	}
	return $cmd;
}

function sch_start($uid,$wlan_num)
{
	$i =1;
	//TRACE_debug("test uid:".$uid);

	if(isscheduled($uid)!="" && isfile("/var/run/".$uid.".DOWN")==1)
	{
		while($i<$wlan_num+1)
		{
 			$phy_band = "BAND24G-1.".$i;
			if ($uid!=$phy_band)//24g not include itself
			{
				//TRACE_debug("test start1:".$phy_band);
 				if(isfile("/var/run/".$phy_band.".UP")==1)
				{
					TRACE_debug("service PHYINF.".$phy_band." stop\n");
					TRACE_debug("service PHYINF.".$phy_band." ".schcmd($phy_band)."\n");
					echo "service PHYINF.".$phy_band." stop\n";
					echo "service PHYINF.".$phy_band." ".schcmd($phy_band)."\n";
				} 
			}
			$phy_band = "BAND5G-1.".$i;
			if ($uid!=$phy_band)//5g not include itself
			{
				//TRACE_debug("test start2:".$phy_band);
				if(isfile("/var/run/".$phy_band.".UP")==1)
				{
					TRACE_debug("service PHYINF.".$phy_band." stop\n");
					TRACE_debug("service PHYINF.".$phy_band." ".schcmd($phy_band)."\n");
					echo "service PHYINF.".$phy_band." stop\n";
					echo "service PHYINF.".$phy_band." ".schcmd($phy_band)."\n";
				}
			}
			$i++;
		}
	}
	
}

	echo "#!/bin/sh\n";
	//TRACE_debug("test start");
	sch_start($UID,4);
	echo "exit 0\n";
?>